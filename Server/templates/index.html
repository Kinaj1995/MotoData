{% extends 'base.html' %}

{% block head %}




{% endblock %}



{% block body %}

<!-- Insert HTML division tag to layout the map -->
<div id="map"></div>


<!-- Insert Javascript (.js) code to create the map -->
<script src="{{ url_for('static', filename='js/leaflet.js')}}"></script>
<script src='https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster-src.js'></script>









<script>


  // -- Converts DMS coordinates to Decimal
  function convertDMStoD(DMS) {

    result = 0.00000
    wholeDegrees = Math.trunc(0.01 * DMS);
    result = wholeDegrees + (DMS - 100.0 * wholeDegrees) / 60.0;
    return result

  }


  // -- Init MarkerCluster
  var mcg = L.markerClusterGroup({
    chunkedLoading: true,
    //spiderfyOnMaxZoom: true
    disableClusteringAtZoom: 16
  });


  // -- specify popup options 
  var customOptions =
  {
    'maxWidth': '500',
    'className': 'custom'
  }



  // -- Sets Markers on the Map
  {% for s in mapsettings.settings %}

  console.log("{{s.filename}}");

  var mapIcon = L.icon({
    iconUrl: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|' + '{{s.color}}' + '&chf=a,s,ee00FFFF',
    iconSize: [20, 30], // size of the icon
    popupAnchor: [0, -15]
  });


  // Read markers data from CSV
  $.get("{{ url_for('static', filename='upload/')}}" + "{{ s.filename }}", function (csvString) {

    // Use PapaParse to convert string to array of objects
    var data = Papa.parse(csvString, { header: true, dynamicTyping: true }).data;

    for (var i in data) {
      var row = data[i];
      var markerPopup = "<br/>Speed: " + row.Speed + "km/h<br/>Roll: " + row.Roll + "Â°<br/>";

      var marker = L.marker([convertDMStoD(row.Latitude), convertDMStoD(row.Longitude)], {
        icon: mapIcon
      }).bindPopup(markerPopup, customOptions);

      mcg.addLayer(marker);
    }
    map.addLayer(mcg);

  });

  {% endfor %}
</script>



<!-- Modal setMarker Data -->
<div class="modal fade" id="setMarkerModal" tabindex="-1" aria-labelledby="setMarkerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="setMarkerModalLabel">Set Marker</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <br>

        <form action="/selectfile" method="POST" enctype="multipart/form-data">
          <input id="selected_filename" type="hidden" name="filename" value="">
          <p class="lead">Please choose a color.</p>
          <br>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="flexRadioBlue" id="flexRadioBlue">
            <label class="form-check-label" for="flexRadioBlue">
              Blue
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="flexRadioGreen" id="flexRadioGreen">
            <label class="form-check-label" for="flexRadioGreen">
              Green
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="flexRadioRed" id="flexRadioRed">
            <label class="form-check-label" for="flexRadioRed">
              Red
            </label>
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schliessen</button>
        <input type="submit" class="btn btn-primary align-left" />
      </div>
      </form>
    </div>
  </div>
</div>



<!-- Modal Upload Data -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="uploadModalLabel">Upload Data</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <br>
        <p class="lead">Please upload your CSV-File.</p>
        <br>
        <form action="/upload_data" method="POST" enctype="multipart/form-data">
          <label for="fname">Filename:</label>
          <input type="text" id="fname" name="fname"><label for="csv"> .csv</label><br><br>
          <input type="file" name="file" />
          <br>
          <br>
          <div class="modal-footer">
            <input type="submit" class="btn btn-primary align-left" />
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block afterscript %}
<script>

  var myModalEl = document.getElementById('setMarkerModal');

  console.log(myModalEl);

  myModalEl.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget; // Gets the button who opens the modal
    console.log(button);

    var filename = button.getAttribute('filename');

    console.log(filename);


    document.getElementById('selected_filename').setAttribute('value', filename);
  })



</script>

{% endblock %}